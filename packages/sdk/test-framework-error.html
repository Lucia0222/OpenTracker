<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Framework Error Boundary Demo</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; }
    button { padding: 8px 14px; cursor: pointer; }
    .card { padding: 16px; border: 1px solid #ddd; border-radius: 8px; max-width: 480px; }
    .log { margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>React Framework Error 监控演示</h1>
  <p>点击按钮触发组件异常，查看控制台日志或下方日志区域。</p>
  <div id="app"></div>
  <div class="log" id="logArea"></div>

  <script type="text/javascript">
    // 简化版的 reportFrameworkError，复用与插件一致的字段结构
    function reportFrameworkError(error, componentStack, reportFn) {
      const payload = {
        errorType: 'react_error',
        timestamp: Date.now(),
        pageUrl: window.location.href,
        userAgent: navigator.userAgent,
        name: error.name || 'ReactError',
        message: error.message || 'Unknown React Error',
        stack: error.stack || '',
        componentStack: componentStack || '',
      };
      reportFn(payload);
    }

    class ReactErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false };
      }
      static getDerivedStateFromError() {
        return { hasError: true };
      }
      componentDidCatch(error, errorInfo) {
        const { report } = this.props;
        if (report) {
          // 与代码库保持一致：将 componentStack 归一化为空字符串
          reportFrameworkError(error, errorInfo.componentStack ?? '', report);
        }
      }
      render() {
        if (this.state.hasError) {
          return this.props.fallback || React.createElement('div', null, '页面出错了，请刷新页面');
        }
        return this.props.children;
      }
    }

    // 一个会抛错的测试组件
    function BuggyCounter() {
      const [count, setCount] = React.useState(0);
      if (count === 2) {
        throw new Error('组件内部故意抛出的错误');
      }
      return React.createElement(
        'div',
        { className: 'card' },
        React.createElement('p', null, `点击两次会抛错：${count}`),
        React.createElement('button', { onClick: () => setCount(count + 1) }, '点击递增')
      );
    }

    // 将上报信息写到页面和控制台
    function logReporter(data) {
      console.log('捕获到框架错误：', data);
      const logArea = document.getElementById('logArea');
      const pre = document.createElement('pre');
      pre.style.whiteSpace = 'pre-wrap';
      pre.textContent = JSON.stringify(data, null, 2);
      logArea.prepend(pre);
    }

    const app = React.createElement(
      ReactErrorBoundary,
      { report: logReporter, fallback: React.createElement('div', null, '已捕获组件错误，UI 已回退。') },
      React.createElement(BuggyCounter, null)
    );

    ReactDOM.createRoot(document.getElementById('app')).render(app);
  </script>
</body>
</html>

