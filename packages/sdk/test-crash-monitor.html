<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crash Monitor Demo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; }
    button { padding: 8px 14px; margin-right: 10px; cursor: pointer; }
    .log { margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <h1>页面崩溃监控演示</h1>
  <p>点击“开始监控”后，若停止心跳 5 秒将触发崩溃上报。</p>
  <div>
    <button id="btnStart">开始监控</button>
    <button id="btnFreeze" disabled>模拟页面卡死（停止心跳）</button>
    <button id="btnResume" disabled>恢复心跳</button>
  </div>
  <div class="log" id="logArea"></div>

  <script type="text/javascript">
    const workerCode = `
let timer;
const TIMEOUT = 5000;
self.onmessage = (e) => {
  if (e.data === 'heartbeat') {
    clearTimeout(timer);
    timer = setTimeout(() => {
      self.postMessage({ type: 'crash' });
    }, TIMEOUT);
  }
};
`;

    class CrashMonitor {
      constructor(reportFn) {
        this.worker = null;
        this.report = reportFn;
        this.timer = null;
      }
      init() {
        if (this.worker) return;
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const workUrl = URL.createObjectURL(blob);
        this.worker = new Worker(workUrl);
        this.worker.onmessage = (e) => {
          if (e.data.type === 'crash') {
            this.handleCrash();
          }
        };
        window.addEventListener('beforeunload', () => {
          this.destroy();
        });
      }
      startHeartbeat() {
        if (this.timer) return;
        this.timer = setInterval(() => {
          this.worker?.postMessage('heartbeat');
        }, 1000);
      }
      stopHeartbeat() {
        if (this.timer) {
          clearInterval(this.timer);
          this.timer = null;
        }
      }
      handleCrash() {
        const data = {
          errorType: 'crash_error',
          timestamp: Date.now(),
          pageUrl: window.location.href,
          userAgent: navigator.userAgent,
          message: 'Page Unresponsive (Heartbeat Timeout)',
          stack: new Error().stack || '',
          name: 'Page Crash',
        };
        this.report?.(data);
        this.destroy();
      }
      destroy() {
        this.stopHeartbeat();
        if (this.worker) {
          this.worker.terminate();
          this.worker = null;
        }
      }
    }

    const logArea = document.getElementById('logArea');
    function log(data) {
      console.log('捕获到崩溃事件：', data);
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(data, null, 2);
      logArea.prepend(pre);
    }

    const monitor = new CrashMonitor(log);

    const btnStart = document.getElementById('btnStart');
    const btnFreeze = document.getElementById('btnFreeze');
    const btnResume = document.getElementById('btnResume');

    btnStart.onclick = () => {
      monitor.init();
      monitor.startHeartbeat();
      btnStart.disabled = true;
      btnFreeze.disabled = false;
      btnResume.disabled = true;
      logArea.innerHTML = '<p>心跳已启动，每秒发送一次。停止 5 秒将视为崩溃。</p>';
    };

    btnFreeze.onclick = () => {
      monitor.stopHeartbeat();
      btnFreeze.disabled = true;
      btnResume.disabled = false;
      logArea.innerHTML += '<p>已停止心跳，5 秒后会触发崩溃上报。</p>';
    };

    btnResume.onclick = () => {
      monitor.startHeartbeat();
      btnFreeze.disabled = false;
      btnResume.disabled = true;
      logArea.innerHTML += '<p>已恢复心跳。</p>';
    };
  </script>
</body>
</html>

